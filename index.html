<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasker - Mesh with Share Links</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚úÖ</text></svg>">

    <style>
        :root {
            --bg-body: #f4f7f6;
            --bg-sidebar: #e1e8e8;
            --bg-container: #ffffff;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #ccc;
            --btn-primary: #3498db;
            --btn-hover: #2980b9;
            --sidebar-width: 260px;
            --active-item: #dbe9f4;
            --deleted-bg: #ffecec;
            --deleted-border: #ffcccc;
            --deleted-text: #c0392b;
        }

        body.dark-mode {
            --bg-body: #121212;
            --bg-sidebar: #1a1a1a;
            --bg-container: #252525;
            --text-primary: #e0e0e0;
            --text-secondary: #aaa;
            --border-color: #444;
            --btn-primary: #2980b9;
            --active-item: #333;
            --deleted-bg: #3e1a1a;
            --deleted-border: #682828;
            --deleted-text: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        .app-layout { display: flex; width: 100%; height: 100%; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }

        .sidebar-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .team-list { list-style: none; padding: 0; flex-grow: 1; overflow-y: auto; }

        .team-item {
            padding: 10px 15px; margin-bottom: 5px; border-radius: 6px;
            cursor: pointer; display: flex; justify-content: space-between;
            align-items: center; transition: background 0.2s;
        }
        .team-item:hover { background: rgba(0,0,0,0.05); }
        .team-item.active { background: var(--active-item); font-weight: 600; border-left: 4px solid var(--btn-primary); }

        .sidebar-controls { margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px; }

        /* Toggle Switch */
        .toggle-row { display: flex; align-items: center; justify-content: space-between; font-size: 13px; margin-bottom: 10px; }
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--btn-primary); }
        input:checked + .slider:before { transform: translateX(14px); }

        .add-team-btn {
            width: 100%; padding: 10px; background: transparent;
            border: 1px dashed var(--border-color); color: var(--text-secondary);
            cursor: pointer; border-radius: 6px;
        }
        .add-team-btn:hover { border-color: var(--btn-primary); color: var(--btn-primary); }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex-grow: 1; padding: 30px; overflow-y: auto;
            background: var(--bg-container); display: flex; flex-direction: column; align-items: center;
        }
        .content-wrapper { width: 600px; max-width: 100%; }

        /* --- MODAL --- */
        #loginModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .login-box {
            background: var(--bg-container); padding: 30px; border-radius: 10px;
            text-align: center; width: 300px; border: 1px solid var(--border-color);
        }
        .login-input {
            width: 90%; padding: 10px; margin: 15px 0;
            border: 1px solid var(--border-color); border-radius: 5px;
            background: var(--bg-body); color: var(--text-primary);
        }

        /* --- NETWORK PANEL --- */
        .network-panel {
            background: rgba(0,0,0,0.03); border: 1px solid var(--border-color);
            padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 13px;
        }
        .my-id-box {
            background: var(--bg-container); padding: 8px; border: 1px dashed var(--border-color);
            cursor: pointer; text-align: center; margin-bottom: 10px; word-break: break-all;
            transition: background 0.2s;
        }
        .my-id-box:hover { background: rgba(0,0,0,0.05); }

        .connect-row { display: flex; gap: 5px; }
        .connect-input { 
            flex-grow: 1; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; 
            background: var(--bg-body); color: var(--text-primary);
        }
        .peer-list { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px; }
        .peer-badge { background: #27ae60; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; }

        /* --- TASKS --- */
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        h2 { margin: 0; }

        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input[type="text"] {
            flex-grow: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px;
            background: var(--bg-body); color: var(--text-primary);
        }
        button.action-btn {
            padding: 10px 15px; background: var(--btn-primary); color: white;
            border: none; border-radius: 6px; cursor: pointer;
        }
        
        ul { list-style: none; padding: 0; }
        
        li.task-item {
            background: var(--bg-body); border: 1px solid var(--border-color);
            border-left: 5px solid transparent; border-radius: 6px;
            margin-bottom: 10px; padding: 10px; display: flex; flex-direction: column;
            transition: transform 0.2s;
        }
        
        /* DELETED STATE STYLING */
        li.task-item.marked-deleted {
            background-color: var(--deleted-bg);
            border-color: var(--deleted-border);
            border-left-color: var(--deleted-text) !important;
        }
        li.task-item.marked-deleted .task-text {
            text-decoration: line-through;
            color: var(--deleted-text);
        }
        li.task-item.marked-deleted .delete-btn {
            background: var(--deleted-text);
            color: white;
            border-radius: 4px;
            padding: 2px 8px;
            font-weight: bold;
        }
        li.task-item.marked-deleted .delete-btn:hover { opacity: 0.8; }

        .task-main { display: flex; align-items: center; gap: 10px; }
        .task-text { flex-grow: 1; }
        .task-meta { font-size: 11px; color: var(--text-secondary); margin-left: 28px; margin-top: 2px; }
        .author-tag { font-weight: bold; }
        
        .completed .task-text { text-decoration: line-through; opacity: 0.6; }
        
        .subtask-list { margin-left: 30px; margin-top: 5px; border-top: 1px dashed var(--border-color); }
        .subtask-item { display: flex; align-items: center; gap: 10px; padding: 5px 0; font-size: 14px; }
        
        .delete-btn { background: transparent; color: #e74c3c; border:none; cursor: pointer; font-size: 14px; }
        .delete-btn:hover { opacity: 0.7; }

        .theme-btn { background: none; border:none; font-size: 20px; cursor: pointer; color: var(--text-primary); }
        
        @media (max-width: 700px) {
            .app-layout { flex-direction: column; }
            .sidebar { width: 100%; height: auto; max-height: 250px; padding: 10px; }
            .main-content { padding: 15px; }
        }
    </style>
</head>
<body>

    <!-- LOGIN MODAL -->
    <div id="loginModal">
        <div class="login-box">
            <h3>Tasker Mesh</h3>
            <p>Enter a nickname to join.</p>
            <input type="text" id="nicknameInput" class="login-input" placeholder="Your Name" maxlength="15">
            <button class="action-btn" onclick="login()">Start Tasking</button>
        </div>
    </div>

    <div class="app-layout">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <span>My Teams</span>
                <button class="theme-btn" onclick="toggleTheme()">üåô</button>
            </div>
            
            <ul class="team-list" id="teamListUi"></ul>
            
            <div class="sidebar-controls">
                <div class="toggle-row">
                    <span>Auto-delete incoming</span>
                    <label class="switch">
                        <input type="checkbox" id="autoDeleteToggle" onchange="toggleAutoDelete()">
                        <span class="slider"></span>
                    </label>
                </div>
                <button class="add-team-btn" onclick="createNewTeam()">+ New Team</button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="content-wrapper">
                
                <div class="header-row">
                    <h2 id="currentTeamTitle">Loading...</h2>
                    <button class="delete-btn" onclick="deleteCurrentTeam()" title="Delete this team list">üóëÔ∏è</button>
                </div>

                <!-- NETWORK PANEL -->
                <div class="network-panel">
                    <div class="my-id-box" onclick="copyId()" title="Click to Copy Shareable Link">
                        <span id="myIdDisplay">Connecting to network...</span>
                    </div>
                    <div class="connect-row">
                        <input type="text" id="peerIdInput" class="connect-input" placeholder="Paste a friend's ID">
                        <button class="action-btn" onclick="connectToPeer()">Connect</button>
                    </div>
                    <div class="peer-list" id="peerList"></div>
                </div>

                <!-- TASK INPUT -->
                <div class="input-group">
                    <input type="text" id="mainInput" placeholder="Add a new task...">
                    <button class="action-btn" onclick="addTask()">Add</button>
                </div>

                <ul id="taskList"></ul>
            </div>
        </div>
    </div>

    <script>
        // --- STATE ---
        let user = { name: 'Anon', color: '#3498db' };
        let appData = {}; 
        let activeListId = null;
        let settings = { autoDelete: false };

        let peer = null;
        let connections = {}; 
        let myPeerId = null;

        // --- INITIALIZATION ---
        const savedData = localStorage.getItem('taskerMesh_v3');
        if (savedData) {
            appData = JSON.parse(savedData);
            activeListId = Object.keys(appData)[0];
        } else {
            const defId = 'team-' + Date.now();
            appData[defId] = { name: 'General', tasks: [] };
            activeListId = defId;
        }

        // Load Settings
        const savedSettings = localStorage.getItem('taskerSettings');
        if(savedSettings) settings = JSON.parse(savedSettings);
        document.getElementById('autoDeleteToggle').checked = settings.autoDelete;

        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

        // --- LOGIN & COLOR SYSTEM ---
        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + "00000".substring(0, 6 - c.length) + c;
        }

        function login() {
            const name = document.getElementById('nicknameInput').value.trim();
            if (!name) return alert("Name required");
            user.name = name;
            user.color = stringToColor(name);
            document.getElementById('loginModal').style.display = 'none';
            initNetwork();
            renderSidebar();
            renderTasks();
        }

        // --- SETTINGS ---
        function toggleAutoDelete() {
            settings.autoDelete = document.getElementById('autoDeleteToggle').checked;
            localStorage.setItem('taskerSettings', JSON.stringify(settings));
            renderTasks(); 
        }

        // --- SIDEBAR ---
        function renderSidebar() {
            const listUi = document.getElementById('teamListUi');
            listUi.innerHTML = '';
            Object.keys(appData).forEach(id => {
                const list = appData[id];
                const li = document.createElement('li');
                li.className = `team-item ${id === activeListId ? 'active' : ''}`;
                li.innerText = list.name;
                li.onclick = () => switchTeam(id);
                listUi.appendChild(li);
            });
            if(appData[activeListId]) document.getElementById('currentTeamTitle').innerText = appData[activeListId].name;
        }

        function createNewTeam() {
            const name = prompt("Enter Team Name:");
            if(!name) return;
            const newId = 'team-' + Date.now() + Math.random().toString(36).substr(2, 5);
            appData[newId] = { name: name, tasks: [] };
            switchTeam(newId);
        }

        function switchTeam(id) {
            activeListId = id;
            renderSidebar();
            renderTasks();
        }

        function deleteCurrentTeam() {
            if(Object.keys(appData).length <= 1) return alert("Cannot delete the last team.");
            if(!confirm("Delete this team?")) return;
            delete appData[activeListId];
            activeListId = Object.keys(appData)[0];
            saveData();
            renderSidebar();
            renderTasks();
        }

        // --- PEERJS & SHARE LINKS ---
        function initNetwork() {
            peer = new Peer(); 
            peer.on('open', (id) => {
                myPeerId = id;
                document.getElementById('myIdDisplay').innerText = `My ID: ${id} (Click to Copy Link)`;
                
                // CHECK FOR HASH (Auto-Connect)
                const targetId = window.location.hash.substring(1);
                if(targetId && targetId !== myPeerId) {
                    console.log("Auto-connecting to ID from URL:", targetId);
                    document.getElementById('peerIdInput').value = targetId; // Visual feedback
                    connectToPeer(targetId);
                }
            });
            peer.on('connection', (conn) => { handleConnection(conn); });
        }

        function connectToPeer(overrideId = null) {
            const remoteId = overrideId || document.getElementById('peerIdInput').value.trim();
            if (!remoteId || remoteId === myPeerId || connections[remoteId]) return;
            const conn = peer.connect(remoteId);
            handleConnection(conn);
        }

        function handleConnection(conn) {
            conn.on('open', () => {
                connections[conn.peer] = conn;
                updatePeerUI();
                if(appData[activeListId]) {
                    conn.send({ 
                        type: 'SYNC', 
                        listId: activeListId,
                        listName: appData[activeListId].name,
                        tasks: appData[activeListId].tasks 
                    });
                }
                const knownPeers = Object.keys(connections).filter(id => id !== conn.peer);
                if (knownPeers.length > 0) conn.send({ type: 'PEERS', peers: knownPeers });
            });

            conn.on('data', (msg) => {
                if (msg.type === 'SYNC') handleSyncMessage(msg);
                else if (msg.type === 'PEERS') {
                    msg.peers.forEach(pId => {
                        if (pId !== myPeerId && !connections[pId]) {
                            handleConnection(peer.connect(pId));
                        }
                    });
                }
            });
            conn.on('close', () => { delete connections[conn.peer]; updatePeerUI(); });
        }

        function broadcastData() {
            const payload = { 
                type: 'SYNC', 
                listId: activeListId,
                listName: appData[activeListId].name,
                tasks: appData[activeListId].tasks 
            };
            Object.values(connections).forEach(conn => { if (conn.open) conn.send(payload); });
        }

        function updatePeerUI() {
            const list = document.getElementById('peerList');
            list.innerHTML = '';
            Object.keys(connections).forEach(id => {
                const badge = document.createElement('span');
                badge.className = 'peer-badge';
                badge.innerText = id.substring(0, 4) + '...';
                list.appendChild(badge);
            });
        }

        function copyId() { 
            // Create full URL with hash
            const url = window.location.origin + window.location.pathname + '#' + myPeerId;
            navigator.clipboard.writeText(url); 
            alert("Shareable Link Copied!\nSend this URL to a friend to auto-connect."); 
        }

        // --- MERGE LOGIC ---
        function handleSyncMessage(msg) {
            const { listId, listName, tasks: remoteTasks } = msg;
            if (!appData[listId]) {
                appData[listId] = { name: listName, tasks: [] };
                renderSidebar();
            }
            const localList = appData[listId];
            let changed = false;

            remoteTasks.forEach(remoteTask => {
                const localTask = localList.tasks.find(t => t.id === remoteTask.id);
                if (!localTask) {
                    localList.tasks.push(remoteTask);
                    changed = true;
                } else {
                    if (remoteTask.lastUpdated > localTask.lastUpdated) {
                        Object.assign(localTask, remoteTask);
                        changed = true;
                    }
                }
            });

            if (changed) {
                saveData();
                if (listId === activeListId) renderTasks();
            }
        }

        // --- TASK LOGIC ---
        function saveData() { localStorage.setItem('taskerMesh_v3', JSON.stringify(appData)); }
        function saveAndBroadcast() { saveData(); renderTasks(); broadcastData(); }

        function addTask() {
            const input = document.getElementById('mainInput');
            const text = input.value.trim();
            if (!text) return;

            const newTask = {
                id: myPeerId + '-' + Date.now(),
                text: text,
                completed: false,
                author: user.name,
                authorColor: user.color,
                lastUpdated: Date.now(),
                deleted: false,
                deletedBy: null,
                subtasks: [],
                _localDismissed: false 
            };

            appData[activeListId].tasks.push(newTask);
            input.value = '';
            saveAndBroadcast();
        }

        function toggleTask(id) {
            const task = appData[activeListId].tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                task.lastUpdated = Date.now();
                saveAndBroadcast();
            }
        }

        function markAsDeleted(id) {
            const task = appData[activeListId].tasks.find(t => t.id === id);
            if (task) {
                task.deleted = true;
                task.deletedBy = user.name;
                task.lastUpdated = Date.now();
                saveAndBroadcast();
            }
        }

        function dismissTask(id) {
            const task = appData[activeListId].tasks.find(t => t.id === id);
            if (task) {
                task._localDismissed = true; 
                saveData(); 
                renderTasks();
            }
        }

        // --- RENDERING ---
        function renderTasks() {
            const ul = document.getElementById('taskList');
            ul.innerHTML = '';
            const currentTasks = appData[activeListId].tasks;

            const visibleTasks = currentTasks.filter(t => {
                if (t._localDismissed) return false; 
                if (t.deleted && settings.autoDelete) return false; 
                return true;
            }).sort((a,b) => b.lastUpdated - a.lastUpdated);

            visibleTasks.forEach(task => {
                const li = document.createElement('li');
                li.className = 'task-item';
                if (task.deleted) li.classList.add('marked-deleted');
                li.style.borderLeftColor = task.authorColor;

                let actionBtn = '';
                if (task.deleted) {
                    actionBtn = `<button class="delete-btn" onclick="dismissTask('${task.id}')" title="Confirm Deletion">üóëÔ∏è Confirm</button>`;
                } else {
                    actionBtn = `<button class="delete-btn" onclick="markAsDeleted('${task.id}')">‚úï</button>`;
                }

                let statusText = '';
                if (task.deleted) {
                    statusText = `<span style="color:var(--deleted-text); font-weight:bold;">Deleted by ${task.deletedBy || 'someone'}</span>`;
                } else {
                    statusText = `Added by <span class="author-tag" style="color:${task.authorColor}">${task.author}</span>`;
                }

                li.innerHTML = `
                    <div class="task-main">
                        <input type="checkbox" ${task.completed ? 'checked' : ''} ${task.deleted ? 'disabled' : ''} onchange="toggleTask('${task.id}')">
                        <span class="task-text ${task.completed ? 'completed' : ''}">${task.text}</span>
                        ${actionBtn}
                    </div>
                    <div class="task-meta">
                        ${statusText}
                    </div>
                `;

                if (!task.deleted) {
                    const subUl = document.createElement('div');
                    subUl.className = 'subtask-list';
                    task.subtasks.forEach(sub => {
                        const subDiv = document.createElement('div');
                        subDiv.className = 'subtask-item';
                        subDiv.innerHTML = `
                            <input type="checkbox" ${sub.completed ? 'checked' : ''} onchange="toggleSubtask('${task.id}', ${sub.id})">
                            <span style="flex-grow:1; ${sub.completed ? 'text-decoration:line-through; opacity:0.6' : ''}">${sub.text}</span>
                        `;
                        subUl.appendChild(subDiv);
                    });
                    li.appendChild(subUl);
                }

                ul.appendChild(li);
            });
        }

        function toggleSubtask(parentId, subId) {
            const task = appData[activeListId].tasks.find(t => t.id === parentId);
            const sub = task.subtasks.find(s => s.id === subId);
            if(sub) { sub.completed = !sub.completed; task.lastUpdated = Date.now(); saveAndBroadcast(); }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }

        document.getElementById('mainInput').addEventListener('keypress', e => { if(e.key === 'Enter') addTask() });
    </script>
</body>
</html>